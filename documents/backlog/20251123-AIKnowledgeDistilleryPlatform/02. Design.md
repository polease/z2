# 02. Design - Z AI Knowledge Distillery Platform (MVP)

## 1. System Architecture Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                         Z Pipeline (MVP)                        │
└─────────────────────────────────────────────────────────────────┘

Input: YouTube URL
    ↓
┌─────────────────────────────────────────────────────────────────┐
│ Stage 1: Video Download & Metadata Extraction                  │
│ - Download video using yt-dlp                                   │
│ - Extract metadata (title, channel, description, date, etc.)    │
│ - Store video file permanently                                  │
└─────────────────────────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────────────────────┐
│ Stage 2: Subtitle/Transcription Processing                     │
│ - Check for YouTube native subtitles                            │
│ - IF subtitles exist: Extract and use them                      │
│ - IF no subtitles: Use local Whisper to transcribe audio        │
│ - Output: English transcript (with timestamps)                  │
└─────────────────────────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────────────────────┐
│ Stage 3: Translation & SRT Generation                          │
│ - Use OpenAI API (GPT-4) to translate transcript to Chinese     │
│ - Generate SRT file with Chinese subtitles                      │
│ - Maintain timestamp alignment                                  │
│ - Output: Chinese SRT file                                      │
└─────────────────────────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────────────────────┐
│ Stage 4: Video Processing & Subtitle Merging                   │
│ - Burn Chinese subtitles into video using FFmpeg                │
│ - Generate new video file with embedded subtitles               │
│ - Output: Video with Chinese subtitles                          │
└─────────────────────────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────────────────────┐
│ Stage 5: Summary & Insights Generation                         │
│ - Use OpenAI API to analyze content                             │
│ - Generate: Summary, key insights, highlights                   │
│ - Output in Chinese                                             │
└─────────────────────────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────────────────────┐
│ Stage 6: Data Storage                                           │
│ - Save all outputs to JSON file                                 │
│ - Store SRT files                                               │
│ - Organize by video ID/date                                     │
└─────────────────────────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────────────────────┐
│ Stage 7: Multi-Platform Publishing                             │
│ - Publish to WeChat Video Channel                               │
│ - Publish to Bilibili                                           │
│ - Upload video with burned-in Chinese subtitles                 │
│ - Include Chinese metadata/description                          │
└─────────────────────────────────────────────────────────────────┘

Output: Published content on WeChat & Bilibili
```

## 2. Component Design

### 2.1 Video Downloader Module

**Responsibilities:**
- Download YouTube videos
- Extract metadata
- Handle errors (unavailable videos, age restrictions, etc.)

**Technology:**
- `yt-dlp` (Python library)

**Input:**
- YouTube URL (string)

**Output:**
```json
{
  "video_id": "abc123",
  "title": "Video Title",
  "channel": "Channel Name",
  "channel_id": "UC...",
  "upload_date": "2024-01-15",
  "duration": 3600,
  "description": "...",
  "thumbnail_url": "...",
  "view_count": 10000,
  "like_count": 500,
  "video_path": "/storage/videos/abc123.mp4",
  "has_subtitles": true,
  "available_subtitle_languages": ["en", "en-auto"]
}
```

**Error Handling:**
- Video unavailable/deleted
- Private/restricted videos
- Network errors
- Invalid URLs

### 2.2 Subtitle/Transcription Module

**Responsibilities:**
- Check for and extract YouTube subtitles
- Transcribe audio if no subtitles exist
- Normalize format

**Technology:**
- `yt-dlp` for subtitle extraction
- `openai-whisper` for local transcription

**Logic Flow:**
```python
if video.has_subtitles:
    transcript = extract_youtube_subtitles(video, language="en")
else:
    audio = extract_audio(video)
    transcript = whisper.transcribe(audio, model="medium")
```

**Output Format:**
```json
{
  "source": "youtube" | "whisper",
  "language": "en",
  "segments": [
    {
      "start": 0.0,
      "end": 5.2,
      "text": "Hello and welcome to this video..."
    },
    {
      "start": 5.2,
      "end": 10.5,
      "text": "Today we're going to discuss..."
    }
  ],
  "full_text": "Combined text of all segments..."
}
```

### 2.3 Translation & SRT Generation Module

**Responsibilities:**
- Translate English transcript to Chinese
- Generate SRT (SubRip) formatted subtitle file
- Maintain precise timestamp alignment
- Handle long transcripts (chunking if needed)

**Technology:**
- OpenAI API (GPT-4 or GPT-4-turbo)
- SRT file format specification

**Translation Strategy:**
- Process segment by segment to maintain timing accuracy
- For short videos (<10 min): Translate in batches of 20-30 segments
- For long videos (>10 min): Process in chunks with context preservation
- Ensure subtitle length is readable (max ~42 characters per line for Chinese)

**Prompt Template:**
```
You are a professional translator specializing in AI and technology content.
Translate the following English subtitle segments to Chinese (Simplified).

Requirements:
- Maintain technical accuracy
- Use appropriate AI/tech terminology in Chinese
- Keep the tone professional and accessible
- Keep translations concise for subtitle readability (max 42 chars per line)
- Preserve meaning and nuance
- Output ONLY the Chinese translation for each segment, preserving the order

English Segments:
{segments_text}

Output the Chinese translations (one per line, in order):
```

**SRT File Format:**
```
1
00:00:00,000 --> 00:00:05,200
大家好，欢迎来到这个视频

2
00:00:05,200 --> 00:00:10,500
今天我们要讨论大语言模型

3
00:00:10,500 --> 00:00:15,800
特别是GPT-4的新特性
```

**Output Format (JSON):**
```json
{
  "language": "zh-CN",
  "srt_file_path": "/storage/subtitles/abc123_zh.srt",
  "segments": [
    {
      "index": 1,
      "start": 0.0,
      "end": 5.2,
      "start_time": "00:00:00,000",
      "end_time": "00:00:05,200",
      "text": "大家好，欢迎来到这个视频"
    },
    {
      "index": 2,
      "start": 5.2,
      "end": 10.5,
      "start_time": "00:00:05,200",
      "end_time": "00:00:10,500",
      "text": "今天我们要讨论大语言模型"
    }
  ],
  "full_text": "Combined Chinese text..."
}
```

**SRT Generation Process:**
1. Translate each segment while maintaining timestamps
2. Format timestamps in SRT format (HH:MM:SS,mmm)
3. Split long translations into multiple subtitle frames if needed
4. Write to .srt file
5. Validate SRT file format

### 2.4 Video Processing & Subtitle Merging Module

**Responsibilities:**
- Burn Chinese SRT subtitles into the video
- Generate new video file with embedded subtitles
- Maintain original video quality
- Optimize for platform requirements

**Technology:**
- FFmpeg (video processing)

**Subtitle Burning Process:**
```bash
ffmpeg -i input_video.mp4 -vf "subtitles=chinese_subtitles.srt:force_style='FontName=SimHei,FontSize=24,PrimaryColour=&H00FFFFFF,OutlineColour=&H00000000,BorderStyle=1,Outline=2,Shadow=1'" -c:a copy output_with_subs.mp4
```

**Subtitle Style Configuration:**
- **Font**: SimHei (黑体) or Microsoft YaHei (微软雅黑)
- **Font Size**: 24 (adjustable based on video resolution)
- **Color**: White with black outline
- **Position**: Bottom center
- **Outline**: 2px black outline for readability
- **Shadow**: Slight shadow for better visibility

**Output:**
```json
{
  "original_video_path": "/storage/videos/abc123.mp4",
  "subtitled_video_path": "/storage/videos/abc123_zh_subbed.mp4",
  "srt_file_used": "/storage/subtitles/abc123_zh.srt",
  "processing_time": 120.5,
  "output_size_mb": 45.2
}
```

**Quality Considerations:**
- Maintain original video codec (H.264/H.265)
- Copy audio stream (no re-encoding)
- Ensure subtitle font is readable on mobile devices
- Test output on both WeChat and Bilibili requirements

### 2.5 Summary & Insights Generation Module

**Responsibilities:**
- Generate content summary
- Extract key insights and takeaways
- Identify highlights/important moments

**Technology:**
- OpenAI API (GPT-4)

**Prompt Template:**
```
You are an AI content analyst. Analyze the following video transcript and generate:

1. A concise summary (2-3 paragraphs)
2. Key insights (3-5 bullet points)
3. Important highlights with timestamps
4. Main topics covered

Video Title: {title}
Channel: {channel}
Transcript (Chinese):
{chinese_transcript}

Output in Chinese, structured format.
```

**Output Format:**
```json
{
  "summary": "这个视频主要讨论了...",
  "key_insights": [
    "关键洞察1",
    "关键洞察2",
    "关键洞察3"
  ],
  "highlights": [
    {
      "timestamp": "00:05:30",
      "description": "讨论了GPT-4的关键特性"
    },
    {
      "timestamp": "00:12:45",
      "description": "展示了实际应用案例"
    }
  ],
  "topics": ["大语言模型", "GPT-4", "应用案例"]
}
```

### 2.6 Storage Module

**Responsibilities:**
- Save all processed data to JSON files
- Store SRT subtitle files
- Organize files by video ID and date
- Maintain video file storage (original and subtitled versions)

**Directory Structure:**
```
/storage/
  /videos/
    /2024-01/
      abc123.mp4                    # Original video
      abc123_zh_subbed.mp4          # Video with burned subtitles
      def456.mp4
      def456_zh_subbed.mp4
  /subtitles/
    /2024-01/
      abc123_en.srt                 # English subtitles (if from YouTube)
      abc123_zh.srt                 # Chinese subtitles
      def456_en.srt
      def456_zh.srt
  /data/
    /2024-01/
      abc123.json
      def456.json
```

**JSON Schema:**
```json
{
  "video_id": "abc123",
  "youtube_url": "https://youtube.com/watch?v=abc123",
  "processed_date": "2024-01-15T10:30:00Z",
  "metadata": {
    "title": "...",
    "channel": "...",
    "upload_date": "...",
    "duration": 3600,
    "description": "...",
    "view_count": 10000,
    "thumbnail_url": "..."
  },
  "files": {
    "original_video": "/storage/videos/2024-01/abc123.mp4",
    "subtitled_video": "/storage/videos/2024-01/abc123_zh_subbed.mp4",
    "english_srt": "/storage/subtitles/2024-01/abc123_en.srt",
    "chinese_srt": "/storage/subtitles/2024-01/abc123_zh.srt"
  },
  "transcripts": {
    "english": {
      "source": "youtube" | "whisper",
      "segments": [...],
      "full_text": "..."
    },
    "chinese": {
      "srt_format": true,
      "segments": [...],
      "full_text": "..."
    }
  },
  "processing": {
    "subtitle_burn": {
      "status": "completed",
      "duration_seconds": 120.5,
      "output_size_mb": 45.2
    }
  },
  "analysis": {
    "summary": "...",
    "key_insights": [...],
    "highlights": [...],
    "topics": [...]
  },
  "publishing": {
    "wechat": {
      "status": "pending" | "published" | "failed",
      "published_date": "...",
      "post_id": "...",
      "url": "..."
    },
    "bilibili": {
      "status": "pending" | "published" | "failed",
      "published_date": "...",
      "video_id": "...",
      "url": "..."
    }
  }
}
```

### 2.7 Publishing Module

**Responsibilities:**
- Upload video with burned subtitles to WeChat Video Channel
- Upload video with burned subtitles to Bilibili
- Include Chinese metadata (title, description, tags)

**Technology:**
- WeChat Video Channel API
- Bilibili Upload API

**Publishing Content Structure:**

**For WeChat:**
- Video file: `abc123_zh_subbed.mp4` (with burned Chinese subtitles)
- Title: `{original_title} (中文字幕)`
- Description: `{chinese_summary}\n\n原视频：{youtube_url}`
- Cover: Original thumbnail

**For Bilibili:**
- Video file: `abc123_zh_subbed.mp4` (with burned Chinese subtitles)
- Title: `{original_title} (中文字幕)`
- Description: `{chinese_summary}\n\n关键洞察：\n{key_insights}\n\n原视频：{youtube_url}`
- Tags: Auto-generated from topics
- Category: 科技/知识
- Cover: Original thumbnail

**Publishing Flow:**
```
1. Prepare subtitled video file (with burned Chinese subtitles)
2. Prepare metadata in Chinese
3. Upload to WeChat:
   - Authenticate
   - Upload video with subtitles
   - Set metadata
   - Publish
4. Upload to Bilibili:
   - Authenticate
   - Upload video with subtitles
   - Submit metadata
   - Publish
5. Update JSON with publishing status and URLs
```

**Note:** Both platforms receive the same video file with Chinese subtitles already burned in, ensuring consistent viewing experience.

## 3. Data Flow

### End-to-End Process Flow

```
User Input: YouTube URL
    ↓
[VideoDownloader]
    → Download video
    → Extract metadata
    → Save video file
    → Return metadata object
    ↓
[SubtitleProcessor]
    → Check for subtitles
    → IF exists: extract to SRT
    → IF not: whisper transcribe to SRT
    → Return English transcript & SRT file
    ↓
[Translator]
    → Translate segments to Chinese
    → Generate Chinese SRT file
    → Maintain timestamp alignment
    → Return Chinese transcript & SRT file
    ↓
[VideoProcessor]
    → Burn Chinese SRT into video using FFmpeg
    → Generate new video file with subtitles
    → Return subtitled video path
    ↓
[AnalysisGenerator]
    → Generate summary (using Chinese transcript)
    → Extract insights
    → Identify highlights
    → Return analysis object
    ↓
[StorageManager]
    → Combine all data
    → Save to JSON
    → Organize files (videos, SRTs, JSON)
    → Return file path
    ↓
[Publisher]
    → Upload subtitled video to WeChat
    → Upload subtitled video to Bilibili
    → Include Chinese metadata
    → Update JSON with status
    → Return publishing results
    ↓
Output: Published URLs + Local data file (JSON, SRTs, videos)
```

## 4. Technology Stack

### Core Technologies
- **Language**: Python 3.10+
- **Video Processing**: yt-dlp
- **Transcription**: openai-whisper
- **AI/Translation**: OpenAI API (GPT-4)
- **Storage**: File system (JSON + MP4)
- **APIs**: WeChat API, Bilibili API

### Key Python Libraries
```
yt-dlp>=2024.0.0
openai>=1.0.0
openai-whisper>=20231117
ffmpeg-python>=0.2.0
requests>=2.31.0
python-dotenv>=1.0.0
pysrt>=1.1.0
```

### System Dependencies
```
ffmpeg (with libass for subtitle burning)
```

### Project Structure
```
z2/
├── src/
│   ├── __init__.py
│   ├── main.py                    # Main pipeline orchestrator
│   ├── downloader.py              # Video download module
│   ├── transcriber.py             # Subtitle/transcription module
│   ├── translator.py              # Translation & SRT generation module
│   ├── video_processor.py         # Video processing & subtitle burning
│   ├── analyzer.py                # Summary/insights generation
│   ├── storage.py                 # Data storage module
│   ├── publisher.py               # Publishing module
│   └── utils/
│       ├── __init__.py
│       ├── config.py              # Configuration management
│       ├── logger.py              # Logging utilities
│       └── srt_utils.py           # SRT file handling utilities
├── storage/
│   ├── videos/                    # Downloaded & processed videos
│   ├── subtitles/                 # SRT files (English & Chinese)
│   └── data/                      # JSON metadata
├── config/
│   ├── .env                       # API keys and secrets
│   └── config.yaml                # Configuration settings
├── tests/
│   └── ...                        # Unit tests
├── requirements.txt
└── README.md
```

## 5. Configuration Management

### Environment Variables (.env)
```
OPENAI_API_KEY=sk-...
WECHAT_APP_ID=...
WECHAT_APP_SECRET=...
BILIBILI_ACCESS_KEY=...
BILIBILI_SECRET_KEY=...
STORAGE_PATH=/path/to/storage
WHISPER_MODEL=medium
```

### Config File (config.yaml)
```yaml
storage:
  base_path: "./storage"
  video_path: "./storage/videos"
  data_path: "./storage/data"

whisper:
  model: "medium"
  language: "en"
  device: "cpu"  # or "cuda" for GPU

openai:
  model: "gpt-4-turbo"
  max_tokens: 4000
  temperature: 0.3

translation:
  chunk_size: 5000  # characters per chunk
  overlap: 200      # overlap between chunks

publishing:
  wechat:
    enabled: true
    title_suffix: " (中文字幕)"
  bilibili:
    enabled: true
    category: "科技"
    tags_auto_generate: true
```

## 6. Error Handling & Retry Logic

### Error Categories

1. **Video Download Errors**
   - Retry: 3 times with exponential backoff
   - Fallback: Mark as failed, log error

2. **Transcription Errors**
   - Whisper failures: Retry with smaller model
   - Fallback: Manual review required

3. **API Errors (OpenAI)**
   - Rate limiting: Exponential backoff
   - Token limits: Chunk and retry
   - Network errors: Retry 3 times

4. **Subtitle Burning Errors**
   - FFmpeg failures: Retry with different encoding settings
   - Font missing: Fallback to default system font
   - Fallback: Manual processing required

5. **Publishing Errors**
   - WeChat/Bilibili API failures: Retry 3 times
   - Fallback: Mark as pending, manual retry

### Logging Strategy
- All operations logged to file and console
- Error severity levels: DEBUG, INFO, WARNING, ERROR, CRITICAL
- Separate log files for each video processing session

## 7. Performance Considerations

### Processing Time Estimates (per video, 10 min duration)
- Download: ~30 seconds
- Subtitle extraction: ~5 seconds
- Whisper transcription (if needed): ~2-5 minutes
- Translation & SRT generation: ~30-60 seconds
- Subtitle burning (FFmpeg): ~1-3 minutes (depends on video length)
- Summary generation: ~30 seconds
- Publishing: ~2-3 minutes per platform

**Total**: ~7-15 minutes per video (depending on transcription and subtitle burning)

### Optimization Opportunities
- Parallel processing for translation chunks
- GPU acceleration for Whisper (can reduce transcription time to ~30-60 seconds)
- Hardware encoding for FFmpeg subtitle burning
- Async API calls for OpenAI
- Batch publishing if processing multiple videos
- Parallel uploads to WeChat and Bilibili

## 8. Security Considerations

### API Keys & Secrets
- Store in .env file (never commit to git)
- Use environment variable injection
- Rotate keys regularly

### Video Storage
- Implement storage quotas
- Consider cloud storage for scalability
- Backup strategy for JSON metadata

### Rate Limiting
- Respect YouTube API limits
- OpenAI API rate limits
- WeChat/Bilibili upload limits

## 9. Testing Strategy

### Unit Tests
- Each module independently testable
- Mock external APIs (OpenAI, WeChat, Bilibili)
- Test error handling paths

### Integration Tests
- End-to-end pipeline with test video
- Verify data flow between modules
- Test publishing flow (staging environment)

### Manual Testing
- Process real YouTube videos
- Verify translation quality
- Check published content on platforms

## 10. Future Enhancements (Post-MVP)

### Phase 2 Features
- Automated channel monitoring
- Quality signal detection
- Video editing and highlights
- Multiple video batch processing
- Web dashboard for monitoring

### Phase 3 Features
- Knowledge graph integration
- Community features
- Additional platforms (Douyin, Kuaishou)
- Advanced analytics

## Next Steps

1. Review this design document
2. Approve or request changes
3. Proceed to implementation phase
4. Set up development environment
5. Implement modules incrementally
6. Test with sample videos
7. Deploy and publish first video

---

**Questions for Review:**
1. Does the architecture make sense for the MVP scope?
2. Are there any missing components or considerations?
3. Should we adjust the technology choices?
4. Any concerns about the data flow or storage structure?
